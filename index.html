<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Fardarias - Disolución de Enlaces</title>
    <style>
        :root {
            --primary-color: #3f51b5;
            --secondary-color: #ff9800;
            --background-color: #f5f5f5;
            --text-color: #333;
            --high-dissolution: #e53935;
            --medium-dissolution: #ff9800;
            --low-dissolution: #4caf50;
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .subtitle {
            font-style: italic;
            color: #666;
        }

        /* Input section */
        .input-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 30px;
        }

        .form-container h2 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #303f9f;
        }

        /* Results section */
        .results-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 992px) {
            .results-section {
                grid-template-columns: 1fr 2fr;
            }
            
            .natal-chart-section {
                grid-column: 1;
                grid-row: 1;
            }
            
            .fardarias-section {
                grid-column: 2;
                grid-row: 1 / span 2;
            }
            
            .dissolution-section {
                grid-column: 1;
                grid-row: 2;
            }
        }

        .natal-chart-section,
        .fardarias-section,
        .dissolution-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            padding: 20px;
        }

        h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
        }

        /* Chart */
        .chart-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .chart-info {
            margin-top: 15px;
            text-align: center;
        }

        /* Timeline */
        .timeline-container {
            position: relative;
            margin-top: 20px;
            overflow-x: auto;
        }

        .timeline-controls {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .timeline {
            position: relative;
            height: 100px;
            margin: 20px 0;
            border-bottom: 2px solid #ccc;
        }

        .timeline-inner {
            position: relative;
            width: 100%;
            height: 100%;
            min-width: 800px;
        }

        .year-marker {
            position: absolute;
            bottom: -20px;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666;
        }

        .period-bar {
            position: absolute;
            top: 20px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--primary-color);
        }

        .period-bar:hover {
            transform: translateY(-3px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }

        .period-bar.level-high {
            background-color: var(--high-dissolution);
        }

        .period-bar.level-medium {
            background-color: var(--medium-dissolution);
        }

        .period-bar.level-low {
            background-color: var(--low-dissolution);
        }

        .period-label {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            background-color: rgba(255,255,255,0.8);
            padding: 2px 5px;
            border-radius: 3px;
        }

        .today-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #f44336;
            z-index: 10;
        }

        .today-marker::after {
            content: 'Hoy';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f44336;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        /* Details panel */
        .details-panel {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .dissolution-panel {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }

        .dissolution-panel.high {
            background-color: rgba(229, 57, 53, 0.1);
            border-left: 4px solid var(--high-dissolution);
        }

        .dissolution-panel.medium {
            background-color: rgba(255, 152, 0, 0.1);
            border-left: 4px solid var(--medium-dissolution);
        }

        .dissolution-panel.low {
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 4px solid var(--low-dissolution);
        }

        /* Critical periods and transits */
        .critical-list,
        .transits-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .critical-item,
        .transit-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
            border-left: 4px solid #ccc;
        }

        .critical-item {
            border-left-color: var(--high-dissolution);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .transit-item.high {
            border-left-color: var(--high-dissolution);
        }

        .transit-item.medium {
            border-left-color: var(--medium-dissolution);
        }

        .transit-date {
            font-weight: bold;
            margin-right: 10px;
        }

        .view-details-btn {
            padding: 5px 10px;
            font-size: 14px;
        }

        /* City results */
        .city-results {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 100;
        }

        .city-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .city-item:hover {
            background-color: #f5f5f5;
        }

        .hidden {
            display: none;
        }

        /* Loading indicator */
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Zodiaco */
        .sign-arc {
            stroke-width: 1;
            stroke: #333;
        }

        .sign-symbol {
            font-size: 20px;
            text-anchor: middle;
            alignment-baseline: middle;
        }

        .planet-symbol {
            font-size: 16px;
            text-anchor: middle;
            alignment-baseline: middle;
            font-weight: bold;
        }

        .planet-circle {
            stroke: #000;
            stroke-width: 1;
        }

        .aspect-line {
            stroke-width: 1;
        }

        .aspect-line.selected {
            stroke-width: 3;
        }

        /* Subperiods table */
        .subperiods-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .subperiods-table th {
            background-color: #f3f3f3;
            text-align: left;
            padding: 8px;
        }

        .subperiods-table td {
            padding: 8px;
            border-top: 1px solid #ddd;
        }

        .subperiods-table tr:hover {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Análisis de Fardarias y Disolución de Enlaces</h1>
            <p class="subtitle">Basado en el zodiaco de 14 signos</p>
        </header>

        <div class="input-section">
            <div class="form-container">
                <h2>Datos de Nacimiento</h2>
                <form id="birth-form">
                    <div class="form-group">
                        <label for="birthCity">Ciudad de nacimiento:</label>
                        <input type="text" id="birthCity" placeholder="Ej: Madrid, España" required>
                        <div id="cityResults" class="city-results hidden"></div>
                    </div>
                    <div class="form-group">
                        <label for="birthDate">Fecha:</label>
                        <input type="date" id="birthDate" required>
                    </div>
                    <div class="form-group">
                        <label for="birthTime">Hora:</label>
                        <input type="time" id="birthTime" required>
                    </div>
                    <button type="submit" id="calculateBtn">Calcular</button>
                </form>
            </div>
        </div>

        <div id="results-section" class="results-section hidden">
            <div class="natal-chart-section">
                <h2>Carta Natal</h2>
                <div class="chart-container">
                    <svg id="chart-svg" viewBox="0 0 600 600"></svg>
                </div>
                <div class="chart-info">
                    <p id="birth-type"></p>
                    <p id="ascendant"></p>
                </div>
            </div>

            <div class="fardarias-section">
                <h2>Análisis de Fardarias</h2>
                <div class="timeline-container">
                    <div class="timeline-controls">
                        <button id="zoom-in">+</button>
                        <button id="zoom-out">-</button>
                        <button id="goto-now">Hoy</button>
                    </div>
                    <div id="fardaria-timeline" class="timeline"></div>
                </div>
                
                <div id="fardaria-details" class="details-panel">
                    <h3>Selecciona un período para ver detalles</h3>
                </div>
            </div>

            <div class="dissolution-section">
                <h2>Períodos Críticos de Disolución</h2>
                <div id="critical-periods" class="critical-list"></div>
                
                <h3>Tránsitos importantes</h3>
                <div id="dissolution-transits" class="transits-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Constantes
        const DIMENSIONS = {
            centerX: 300,
            centerY: 300,
            radius: 250,
            middleRadius: 180,
            innerRadius: 110,
            glyphRadius: 235
        };

        const SIGNS = [
            {name: 'ARIES', start: 354, length: 36, symbol: '♈', color: '#FFE5E5'},
            {name: 'TAURO', start: 30, length: 30, symbol: '♉', color: '#E5FFE5'},
            {name: 'GEMINI', start: 60, length: 30, symbol: '♊', color: '#FFFFE5'},
            {name: 'CANCER', start: 90, length: 30, symbol: '♋', color: '#E5FFFF'},
            {name: 'LEO', start: 120, length: 30, symbol: '♌', color: '#FFE5E5'},
            {name: 'VIRGO', start: 150, length: 36, symbol: '♍', color: '#E5FFE5'},
            {name: 'LIBRA', start: 186, length: 24, symbol: '♎', color: '#FFFFE5'},
            {name: 'SCORPIO', start: 210, length: 30, symbol: '♏', color: '#E5FFFF'},
            {name: 'OPHIUCHUS', start: 240, length: 12, symbol: '⛎', color: '#FFFFE5'},
            {name: 'SAGITTARIUS', start: 252, length: 18, symbol: '♐', color: '#FFE5E5'},
            {name: 'CAPRICORN', start: 270, length: 36, symbol: '♑', color: '#E5FFE5'},
            {name: 'AQUARIUS', start: 306, length: 18, symbol: '♒', color: '#FFFFE5'},
            {name: 'PEGASUS', start: 324, length: 6, symbol: '∩', color: '#E5FFFF'},
            {name: 'PISCES', start: 330, length: 24, symbol: '♓', color: '#E5FFFF'}
        ];

        const PLANET_SYMBOLS = {
            'SOL': '☉',
            'LUNA': '☽',
            'MERCURIO': '☿',
            'VENUS': '♀',
            'MARTE': '♂',
            'JÚPITER': '♃',
            'SATURNO': '♄',
            'URANO': '♅',
            'NEPTUNO': '♆',
            'PLUTÓN': '♇',
            'ASC': 'ASC',
            'MC': 'MC',
            'DSC': 'DSC',
            'IC': 'IC'
        };

        // Variables globales
        let chartData = null;
        let fardariaData = null;
        let zoomLevel = 100; // Porcentaje de zoom para línea temporal

        // Inicialización al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Referencias a elementos DOM
            const birthForm = document.getElementById('birth-form');
            const cityInput = document.getElementById('birthCity');
            const cityResults = document.getElementById('cityResults');
            const resultsSection = document.getElementById('results-section');
            
            // Inicializar fecha con fecha actual
            document.getElementById('birthDate').valueAsDate = new Date();
            
            // Configurar búsqueda de ciudades
            setupCitySearch();
            
            // Escuchar envío del formulario
            birthForm.addEventListener('submit', function(e) {
                e.preventDefault();
                calculateNatalChart();
            });
            
            // Configurar controles de zoom de línea temporal
            document.getElementById('zoom-in').addEventListener('click', () => {
                zoomLevel += 20;
                updateTimelineZoom();
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                zoomLevel = Math.max(100, zoomLevel - 20);
                updateTimelineZoom();
            });
            
            document.getElementById('goto-now').addEventListener('click', () => {
                const todayMarker = document.querySelector('.today-marker');
                if (todayMarker) {
                    // Centrar en el marcador de hoy
                    const timeline = document.querySelector('.timeline');
                    const markerLeft = parseFloat(todayMarker.style.left);
                    timeline.scrollLeft = (markerLeft / 100) * timeline.scrollWidth - timeline.clientWidth / 2;
                }
            });
        });

        // Funciones para la aplicación
        
        // Actualizar zoom de la línea temporal
        function updateTimelineZoom() {
            const timelineInner = document.querySelector('.timeline-inner');
            if (timelineInner) {
                timelineInner.style.width = `${zoomLevel}%`;
            }
        }
        
        // Configurar búsqueda de ciudad con autocompletado
        function setupCitySearch() {
            let typingTimer;
            const cityInput = document.getElementById('birthCity');
            const cityResults = document.getElementById('cityResults');
            
            cityInput.addEventListener('input', function() {
                clearTimeout(typingTimer);
                
                if (cityInput.value.length >= 3) {
                    typingTimer = setTimeout(() => searchCity(cityInput.value), 500);
                } else {
                    cityResults.innerHTML = '';
                    cityResults.classList.add('hidden');
                }
            });
            
            // Ocultar resultados al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (e.target !== cityInput && !cityResults.contains(e.target)) {
                    cityResults.classList.add('hidden');
                }
            });
        }
        
        // Buscar ciudad
        function searchCity(query) {
            fetch(`/cities?ciudad=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displayCityResults(data.ciudades || []);
                })
                .catch(error => {
                    console.error('Error buscando ciudad:', error);
                });
        }
        
        // Mostrar resultados de búsqueda de ciudades
        function displayCityResults(cities) {
            const cityResults = document.getElementById('cityResults');
            const cityInput = document.getElementById('birthCity');
            
            cityResults.innerHTML = '';
            
            if (cities.length === 0) {
                const div = document.createElement('div');
                div.className = 'city-item';
                div.textContent = 'No se encontraron ciudades';
                cityResults.appendChild(div);
            } else {
                cities.forEach(city => {
                    const div = document.createElement('div');
                    div.className = 'city-item';
                    div.textContent = city.nombre || city;
                    
                    div.addEventListener('click', function() {
                        cityInput.value = city.nombre || city;
                        cityResults.classList.add('hidden');
                    });
                    
                    cityResults.appendChild(div);
                });
            }
            
            cityResults.classList.remove('hidden');
        }
        
        // Calcular carta natal
        function calculateNatalChart() {
            const birthCity = document.getElementById('birthCity').value;
            const birthDate = document.getElementById('birthDate').value;
            const birthTime = document.getElementById('birthTime').value;
            
            if (!birthCity || !birthDate || !birthTime) {
                alert('Por favor, completa todos los campos.');
                return;
            }
            
            // Mostrar indicador de carga
            showLoading(true);
            
            // Llamar al API para calcular la carta natal
            fetch('/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    city: birthCity,
                    date: birthDate,
                    time: birthTime
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Guardar datos de la carta
                chartData = data;
                
                // Renderizar carta natal
                renderNatalChart(data.positions);
                
                // Mostrar información básica
                document.getElementById('birth-type').textContent = 
                    `Tipo de nacimiento: ${data.isDry ? 'Seco' : 'Húmedo'}`;
                
                const asc = data.positions.find(p => p.name === "ASC");
                if (asc) {
                    document.getElementById('ascendant').textContent = 
                        `Ascendente: ${asc.sign} (${asc.longitude.toFixed(2)}°)`;
                }
                
                // Calcular fardarias
                calculateFardarias(data);
                
                // Mostrar sección de resultados
                document.getElementById('results-section').classList.remove('hidden');
                
                // Ocultar indicador de carga
                showLoading(false);
            })
            .catch(error => {
                console.error('Error calculando carta natal:', error);
                alert(`Error: ${error.message || 'No se pudo calcular la carta natal'}`);
                showLoading(false);
            });
        }
        
        // Calcular fardarias y análisis de disolución
        function calculateFardarias(chartData) {
            const asc = chartData.positions.find(p => p.name === "ASC");
            const sol = chartData.positions.find(p => p.name === "SOL");
            
            if (!asc || !sol) {
                console.error('No se encontró ascendente o sol en los datos');
                return;
            }
            
            fetch('/calculate_fardarias', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    birthDate: document.getElementById('birthDate').value,
                    ascSign: asc.sign,
                    sunLongitude: sol.longitude,
                    isDry: chartData.isDry
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Guardar datos de fardarias
                fardariaData = data;
                
                // Renderizar línea temporal de fardarias
                renderFardariaTimeline(data.periods);
                
                // Mostrar períodos críticos
                showCriticalPeriods(data.periods);
                
                // Mostrar tránsitos relevantes
                showDissolutionTransits(data.transits);
            })
            .catch(error => {
                console.error('Error calculando fardarias:', error);
                alert(`Error: ${error.message || 'No se pudieron calcular las fardarias'}`);
            });
        }
        
        // Renderizar carta natal
        function renderNatalChart(positions) {
            const svg = document.getElementById('chart-svg');
            svg.innerHTML = '';
            
            // Círculo exterior
            createCircle(svg, DIMENSIONS.centerX, DIMENSIONS.centerY, DIMENSIONS.radius, 'none', '#333', 2);
            
            // Dibujar signos zodiacales
            for (const sign of SIGNS) {
                // Crear arco del signo
                const path = createArcPath(sign.start, sign.start + sign.length);
                const arc = createSVGElement('path', {
                    d: path,
                    fill: sign.color,
                    class: 'sign-arc'
                });
                svg.appendChild(arc);
                
                // Añadir símbolo del signo
                const midAngle = ((sign.start + sign.length/2 - 90) * Math.PI) / 180;
                const symbolX = DIMENSIONS.centerX + DIMENSIONS.glyphRadius * Math.cos(midAngle);
                const symbolY = DIMENSIONS.centerY + DIMENSIONS.glyphRadius * Math.sin(midAngle);
                
                const symbol = createSVGElement('text', {
                    x: symbolX,
                    y: symbolY,
                    class: 'sign-symbol'
                });
                symbol.textContent = sign.symbol;
                svg.appendChild(symbol);
            }
            
            // Círculo interior
            createCircle(svg, DIMENSIONS.centerX, DIMENSIONS.centerY, DIMENSIONS.innerRadius, 'white', '#333', 1);
            
            // Dibujar planetas
            for (const planet of positions) {
                const angle = ((planet.longitude - 90) * Math.PI) / 180;
                const distance = planet.name === 'ASC' || planet.name === 'MC' || 
                                planet.name === 'DSC' || planet.name === 'IC' ? 
                                DIMENSIONS.radius - 15 : DIMENSIONS.innerRadius - 20;
                
                const x = DIMENSIONS.centerX + distance * Math.cos(angle);
                const y = DIMENSIONS.centerY + distance * Math.sin(angle);
                
                // Círculo del planeta
                const planetColor = getPlanetColor(planet.name, planet.longitude);
                createCircle(svg, x, y, 5, planetColor, '#000', 1, 'planet-circle');
                
                // Símbolo del planeta
                const symbol = createSVGElement('text', {
                    x: x,
                    y: y - 10,
                    class: 'planet-symbol'
                });
                symbol.textContent = PLANET_SYMBOLS[planet.name] || planet.name;
                svg.appendChild(symbol);
            }
        }
        
        // Renderizar línea temporal de fardarias
        function renderFardariaTimeline(periods) {
            const container = document.getElementById('fardaria-timeline');
            container.innerHTML = '';
            
            // Filtrar solo períodos de nivel 1
            const mainPeriods = periods.filter(p => p.level === 1);
            
            if (mainPeriods.length === 0) {
                container.innerHTML = '<p>No hay periodos de fardarias disponibles</p>';
                return;
            }
            
            // Crear escala temporal
            const firstPeriod = mainPeriods[0];
            const lastPeriod = mainPeriods[mainPeriods.length - 1];
            
            const startYear = new Date(firstPeriod.start).getFullYear();
            const endYear = new Date(lastPeriod.end).getFullYear();
            const totalYears = endYear - startYear;
            
            // Crear línea de tiempo
            const timelineInner = document.createElement('div');
            timelineInner.className = 'timeline-inner';
            timelineInner.style.width = `${zoomLevel}%`;
            
            // Añadir marcadores de años
            for (let year = startYear; year <= endYear; year++) {
                const yearMarker = document.createElement('div');
                yearMarker.className = 'year-marker';
                yearMarker.textContent = year;
                yearMarker.style.left = `${((year - startYear) / totalYears) * 100}%`;
                timelineInner.appendChild(yearMarker);
            }
            
            // Añadir períodos
            mainPeriods.forEach((period, index) => {
                const startDate = new Date(period.start);
                const endDate = new Date(period.end);
                
                const startPos = ((startDate.getFullYear() + startDate.getMonth()/12) - startYear) / totalYears;
                const endPos = ((endDate.getFullYear() + endDate.getMonth()/12) - startYear) / totalYears;
                const width = (endPos - startPos) * 100;
                
                const periodEl = document.createElement('div');
                periodEl.className = `period-bar level-${period.dissolution?.level || 'none'}`;
                periodEl.style.left = `${startPos * 100}%`;
                periodEl.style.width = `${width}%`;
                periodEl.dataset.periodIndex = index;
                
                const labelEl = document.createElement('div');
                labelEl.className = 'period-label';
                labelEl.textContent = `${period.planet}`;
                periodEl.appendChild(labelEl);
                
                // Evento de clic para mostrar detalles
                periodEl.addEventListener('click', () => showPeriodDetails(period));
                
                timelineInner.appendChild(periodEl);
            });
            
            container.appendChild(timelineInner);
            
            // Añadir marcador de hoy
            addTodayMarker(timelineInner, startYear, totalYears);
        }
        
        // Añadir marcador de la fecha actual
        function addTodayMarker(timelineEl, startYear, totalYears) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            
            const position = ((currentYear + currentMonth/12) - startYear) / totalYears;
            
            // Verificar si la fecha actual está en el rango de la línea de tiempo
            if (position >= 0 && position <= 1) {
                const marker = document.createElement('div');
                marker.className = 'today-marker';
                marker.style.left = `${position * 100}%`;
                marker.title = 'Hoy';
                
                timelineEl.appendChild(marker);
            }
        }
        
        // Mostrar detalles de un período seleccionado
        function showPeriodDetails(period) {
            const detailsPanel = document.getElementById('fardaria-details');
            
            // Formatear fechas
            const startDate = new Date(period.start).toLocaleDateString();
            const endDate = new Date(period.end).toLocaleDateString();
            
            let dissolutionHtml = '';
            if (period.dissolution) {
                const { level, score, factors } = period.dissolution;
                
                dissolutionHtml = `
                    <div class="dissolution-panel ${level}">
                        <h4>Potencial de disolución: ${level.toUpperCase()}</h4>
                        <p>Puntuación: ${score}</p>
                        
                        <h5>Factores:</h5>
                        <ul>
                            ${factors.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                        
                        <div class="interpretation">
                            <h5>Interpretación:</h5>
                            <p>${period.dissolution.interpretation || 'No disponible'}</p>
                        </div>
                    </div>
                `;
            }
            
            detailsPanel.innerHTML = `
                <h3>${period.planet}</h3>
                <p class="period-dates">${startDate} - ${endDate}</p>
                ${dissolutionHtml}
                
                <div class="subperiods-container">
                    <h4>Subperíodos</h4>
                    <div class="subperiods-list">
                        ${renderSubperiodsHTML(period.subPeriods || [])}
                    </div>
                </div>
            `;
        }
        
        // Generar HTML para subperíodos
        function renderSubperiodsHTML(subperiods) {
            if (!subperiods.length) return '<p>No hay subperíodos disponibles</p>';
            
            return `
                <table class="subperiods-table">
                    <thead>
                        <tr>
                            <th>Planeta</th>
                            <th>Inicio</th>
                            <th>Fin</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${subperiods.map(sp => `
                            <tr>
                                <td>${sp.planet}</td>
                                <td>${new Date(sp.start).toLocaleDateString()}</td>
                                <td>${new Date(sp.end).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Mostrar períodos críticos de disolución
        function showCriticalPeriods(periods) {
            const container = document.getElementById('critical-periods');
            
            // Filtrar períodos críticos (nivel alto)
            const criticalPeriods = periods.filter(p => 
                p.level === 1 && p.dissolution && p.dissolution.level === 'high'
            );
            
            if (criticalPeriods.length === 0) {
                container.innerHTML = '<p class="no-data">No se encontraron períodos críticos</p>';
                return;
            }
            
            let html = '<ul class="critical-list">';
            
            criticalPeriods.forEach(period => {
                const startDate = new Date(period.start).toLocaleDateString();
                const endDate = new Date(period.end).toLocaleDateString();
                
                html += `
                    <li class="critical-item" data-period-id="${periods.indexOf(period)}">
                        <span class="critical-planet">${period.planet}</span>
                        <span class="critical-dates">${startDate} - ${endDate}</span>
                        <button class="view-details-btn" onclick="showPeriodDetails(fardariaData.periods[${periods.indexOf(period)}])">Ver detalles</button>
                    </li>
                `;
            });
            
            html += '</ul>';
            container.innerHTML = html;
        }
        
        // Mostrar tránsitos de disolución
        function showDissolutionTransits(transits) {
            const container = document.getElementById('dissolution-transits');
            
            if (!transits || transits.length === 0) {
                container.innerHTML = '<p class="no-data">No hay tránsitos relevantes disponibles</p>';
                return;
            }
            
            let html = '<ul class="transits-list">';
            
            transits.forEach(transit => {
                const date = new Date(transit.date).toLocaleDateString();
                
                html += `
                    <li class="transit-item ${transit.importance}">
                        <span class="transit-date">${date}</span>
                        <span class="transit-desc">${transit.description}</span>
                    </li>
                `;
            });
            
            html += '</ul>';
            container.innerHTML = html;
        }
        
        // Funciones utilitarias
        
        // Crear elemento SVG
        function createSVGElement(tag, attributes = {}) {
            const element = document.createElementNS("http://www.w3.org/2000/svg", tag);
            
            for (const [key, value] of Object.entries(attributes)) {
                element.setAttribute(key, value);
            }
            
            return element;
        }
        
        // Crear círculo SVG
        function createCircle(parent, cx, cy, r, fill, stroke, strokeWidth, className) {
            const circle = createSVGElement('circle', {
                cx, cy, r, fill, stroke, 'stroke-width': strokeWidth
            });
            
            if (className) {
                circle.setAttribute('class', className);
            }
            
            parent.appendChild(circle);
            return circle;
        }
        
        // Crear path de arco para signos zodiacales
        function createArcPath(startAngle, endAngle) {
            const start = ((startAngle - 90) * Math.PI) / 180;
            const end = ((endAngle - 90) * Math.PI) / 180;
            
            const x1 = DIMENSIONS.centerX + DIMENSIONS.radius * Math.cos(start);
            const y1 = DIMENSIONS.centerY + DIMENSIONS.radius * Math.sin(start);
            const x2 = DIMENSIONS.centerX + DIMENSIONS.radius * Math.cos(end);
            const y2 = DIMENSIONS.centerY + DIMENSIONS.radius * Math.sin(end);
            
            const x1Inner = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(start);
            const y1Inner = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(start);
            const x2Inner = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(end);
            const y2Inner = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(end);
            
            const largeArcFlag = end - start <= Math.PI ? "0" : "1";
            
            return `M ${x1} ${y1} A ${DIMENSIONS.radius} ${DIMENSIONS.radius} 0 ${largeArcFlag} 1 ${x2} ${y2} L ${x2Inner} ${y2Inner} A ${DIMENSIONS.innerRadius} ${DIMENSIONS.innerRadius} 0 ${largeArcFlag} 0 ${x1Inner} ${y1Inner} Z`;
        }
        
        // Obtener color para un planeta según su posición
        function getPlanetColor(planet, longitude) {
            const COLORS = {
                RED: '#FF0000',
                GREEN: '#00FF00',
                BLUE: '#0000FF',
                YELLOW: '#FFFF00'
            };
            
            if (planet === 'ASC' || planet === 'MC' || planet === 'DSC' || planet === 'IC') {
                return '#000000';
            }
            
            if (planet === 'JÚPITER') {
                if ((longitude >= 306.00 && longitude <= 360.00) || (longitude >= 0.00 && longitude <= 150.00)) 
                    return COLORS.BLUE;
                if (longitude > 150.00 && longitude < 306.00) 
                    return COLORS.RED;
            }

            if (planet === 'SATURNO') {
                if ((longitude >= 330.00 && longitude <= 360.00) || (longitude >= 0.00 && longitude <= 150.00))
                    return COLORS.YELLOW;
                if (longitude > 240.00 && longitude <= 252.00) return COLORS.YELLOW;
                if (longitude > 252.00 && longitude <= 330.00) return COLORS.RED;
                if (longitude > 150.00 && longitude <= 240.00) return COLORS.RED;
                return COLORS.YELLOW;
            }

            if (longitude > 150.00 && longitude <= 330.00) {
                switch(planet) {
                    case 'SOL': case 'MERCURIO': case 'URANO': return COLORS.GREEN;
                    case 'VENUS': case 'LUNA': return COLORS.YELLOW;
                    case 'MARTE': case 'PLUTÓN': return COLORS.BLUE;
                    case 'NEPTUNO': return COLORS.RED;
                    default: return '#000000';
                }
            } else {
                switch(planet) {
                    case 'SOL': case 'MARTE': case 'PLUTÓN': return COLORS.RED;
                    case 'VENUS': return COLORS.GREEN;
                    case 'MERCURIO': case 'SATURNO': case 'URANO': return COLORS.YELLOW;
                    case 'LUNA': case 'NEPTUNO': return COLORS.BLUE;
                    default: return '#000000';
                }
            }
        }
        
        // Mostrar/ocultar indicador de carga
        function showLoading(show) {
            // Eliminar indicador existente si lo hay
            let loadingEl = document.getElementById('loading-indicator');
            
            if (loadingEl) {
                loadingEl.remove();
            }
            
            if (show) {
                loadingEl = document.createElement('div');
                loadingEl.id = 'loading-indicator';
                loadingEl.className = 'loading-indicator';
                
                loadingEl.innerHTML = `
                    <div class="spinner"></div>
                    <p>Calculando...</p>
                `;
                
                document.body.appendChild(loadingEl);
            }
        }
    </script>
</body>
</html>
